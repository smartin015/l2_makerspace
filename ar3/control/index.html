<html>
<head>
<meta content="text/html;charset=utf-8" http-equiv="Content-Type">
<meta content="utf-8" http-equiv="encoding">
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
<script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
<script src="/RGraph.common.core.js"></script>
<script src="/RGraph.line.js"></script>
<style>
  body {
    background-color: grey;
  }
  body.connected {
    background-color: white;
  }
  .content {
    width: 1200px;
    margin: 2vh;
    margin-left: auto;
    margin-right: auto;
  }
  table {
    width: 100%;
  }

  label.is-checked > span.mdl-checkbox__label {
    color: red;
    font-weight: bold;
    animation: blinker 1s linear infinite;
  }

  @keyframes blinker {
    50% {
      opacity: 0.25;
    }
  }
</style>
</head>
<body>
<div class="mdl-card mdl-shadow--2dp content">
  <div class="mdl-card__title" style="border-bottom: 1px gray solid;"><h2 class="mdl-card__title-text" id="status"></h2></div>
  <div class="mdl-card__supporting-text">
     <label class = "mdl-checkbox mdl-js-checkbox" for = "limit_override">
        <input type = "checkbox" id = "limit_override" 
           class = "mdl-checkbox__input">
        <span class = "mdl-checkbox__label">limit_override</span>
     </label>

    <table class="mdl-data-table mdl-js-data-table" style="background-color: transparent !important;">
      <thead>
        <tr>
          <th>Mask</th>
          <th class="mdl-data-table__cell--non-numeric">Position</th>
          <th>Target</th>
          <th>Value</th>
          <th class="mdl-data-table__cell--non-numeric">Velocity</th>
          <th>Target</th>
          <th>Value</th>
        </tr>
      </thead>
      <tbody>
        <tr id="repeatntimes">
          <td class="mask"></td>
          <td style="width:300px">
            <input class="mdl-slider mdl-js-slider posslider" type="range" id="s6" min="-3.14159" max="3.14159" value="0" step="0.1">
          </td>
          <td class="postgt">0</td>
          <td class="posval">#</td>
          <td style="width:300px">
            <input class="mdl-slider mdl-js-slider velslider" type="range" id="s6" min="0.25" max="4.0" value="0.25" step="0.25">
          </td>
          <td class="veltgt">0</td>
          <td class="velval">#</td>
        </tr>
      </tbody>
      <canvas id="posCanvas" width="500" height="150" style="width: 100%">[No canvas support]</canvas>
      <canvas id="velCanvas" width="500" height="150" style="width: 100%">[No canvas support]</canvas>
    </table>
    <div id="lastUpdate"></div>
  </div>
</div>
<script>
var ws = null; //See reconnect()
var state = null; //See init()
var ui = null; //See init()

const STEPS_PER_REV = [4096,4096,4096,4096,4096,4096];
const GRAPH_DOMAIN_SEC = 20;
const SEND_STATE_PD_MILLIS = 100;
const EVENT_LOG_PD = 2000;

// https://medium.com/cafe-pixo/inclusive-color-palettes-for-the-web-bbfe8cf2410e
const INCLUSIVE_COLORS = ['#E1DAAE', '#FF934F', '#CC2D35', '#058ED9', '#848FA2', '#2D3142'];

function initGraph(id, yMin, yMax) {
  // https://www.rgraph.net/canvas/howto-scrolling.html
  return new RGraph.Line({
      id,
      data: [...Array(state.num_j)].map(e => Array(GRAPH_DOMAIN_SEC * 1000 / SEND_STATE_PD_MILLIS)),
      options: {
          //yaxisScaleMax: yMax,
          //yaxisScaleMin: yMin,
          tickmarksStyle: null,
          linewidth: 1,
          shadow: null,
          colors: INCLUSIVE_COLORS,
          backgroundGridVlines: false,
          backgroundGridBorder: false,
          backgroundGridColor: '#eee',
          xaxisLabels: ['20s','15s','10s','5s','0s'],
          xaxis: false,
          textSize: 7,
      }
  }).draw();
}

function setLimitOverride(event) {
  state.limit_override = event.target.checked;
  console.log(`Limit override: ${(state.limit_override) ? "ENABLED" : "disabled"}`);
  for (let i = 0; i < state.num_j; i++) {
    state.tmask[i] = (state.tmask[i] & ~0x01) | ((state.limit_override) ? 1 : 0);
  }
}

function setStatus(status) {
  document.getElementById("status").innerText = status;
}

function setLastUpdate() {
  document.getElementById("lastUpdate").innerText = `last update ${millis() - lastSendState}ms`;
}

function millis() {
  return (new Date().getTime());
}

let lastSendState = 0;
function sendState() {
  if (ws.readyState === ws.OPEN) {
    ws.send([state.tmask.join(","), state.tpos.join(","), state.tvel.join(",")].join("|"));
    lastSendState = millis();
  }
}

function tick() {
  setLastUpdate();
  if (millis() > lastSendState + SEND_STATE_PD_MILLIS) {
    sendState();
  }

  // Clear (NOT reset) the canvas
  RGraph.clear(ui.posgraph.canvas);
  RGraph.clear(ui.velgraph.canvas);
  ui.posgraph.draw();
  ui.velgraph.draw();
}

function handleMessage(event) {
  let now = millis();
  if (now - state.last_event_log > EVENT_LOG_PD) {
    console.log(event.data);
    state.last_event_log = now;
  }
  mpv = event.data.split("|");
  m = mpv[0].split(",");
  p = mpv[1].split(",");
  v = mpv[2].split(",");
  for (let i = 0; i < state.num_j; i++) {
    state.mask[i]=m[i];
    ui.mask[i].innerText = state.mask[i];

    state.pos[i]=p[i];
    state.vel[i]=v[i];
    let pos_norm = state.pos[i] * (2*3.14159)/STEPS_PER_REV[i];
    ui.posgraph.original_data[i].shift();
    ui.posgraph.original_data[i].push(pos_norm);
    ui.posval[i].innerText = pos_norm.toFixed(2);

    let vel_norm = state.vel[i] * (2*3.14159)/STEPS_PER_REV[i];
    ui.velgraph.original_data[i].shift();
    ui.velgraph.original_data[i].push(vel_norm);
    ui.velval[i].innerText = vel_norm.toFixed(2);
  }
  
  tick();
}

function startWebsocket() {
  ws = new WebSocket(`ws://${document.location.hostname}:8001`);

  ws.onopen = (event) => {
    console.log("socket opened");
    setStatus(`Connected to ${ws.url}`);
    document.getElementsByTagName("body")[0].className = "connected";
    sendState();
  };

  ws.onclose = (event) => {
    console.log("socket closed, attempting reconnect in 5s");
    setStatus("Disconnected (reconnecting in 5s)");
    document.getElementsByTagName("body")[0].className = "";
    setTimeout(startWebsocket, 5000);
  };
  ws.onmessage = handleMessage;
}

function init(num_j) {
  console.log(`${num_j} joints`);

  state = {
    num_j,
    pos: Array(num_j).fill(0),
    vel: Array(num_j).fill(0),
    mask: Array(num_j).fill(0),
    tpos: Array(num_j).fill(0),
    tvel: Array(num_j).fill(0),
    tmask: Array(num_j).fill(0),
    limit_override: false,
    last_event_log: millis(),
  };

  let tmpl = document.getElementById("repeatntimes");
  let tbody = document.querySelector("tbody");
  for (let i = 1; i < state.num_j; i++) {
    tbody.appendChild(tmpl.cloneNode(true));
  }

  ui = {
    mask: document.getElementsByClassName("mask"),

    posslider: document.getElementsByClassName("posslider"),
    postgt: document.getElementsByClassName("postgt"),
    posval: document.getElementsByClassName("posval"),
    posgraph: initGraph("posCanvas", -4, 4),
    
    velslider: document.getElementsByClassName("velslider"),
    veltgt: document.getElementsByClassName("veltgt"),
    velval: document.getElementsByClassName("velval"),
    velgraph: initGraph("velCanvas", 0, 4),
  };


  for (let i = 0; i < state.num_j; i++) {
    // Apply colors matching the graphs
    for (let inp of tbody.children[i].querySelectorAll("input")) {
      inp.style = `background-color: ${INCLUSIVE_COLORS[i]}`;
    }

    ui.posslider[i].oninput = (e) => {
      state.tpos[i] = Math.round(e.target.value / (2*3.14159) * STEPS_PER_REV[i]);
      ui.postgt[i].innerText = parseFloat(e.target.value).toFixed(2);
    }
    ui.velslider[i].oninput = (e) => {
      state.tvel[i] = Math.round(e.target.value / (2*3.14159) * STEPS_PER_REV[i]);
      ui.veltgt[i].innerText = parseFloat(e.target.value).toFixed(2);
    }

    document.getElementById("limit_override").onchange = setLimitOverride;
  }
  
  startWebsocket();
  setInterval(tick, 100);
}
window.onload = function() {
  return fetch('/config').then(r => r.text()).then(data => init(parseInt(data)));
}

</script>
</body>
</html>
