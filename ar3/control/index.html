<html>
<head>
<link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
<link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
<script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>
<script src="/RGraph.common.core.js"></script>
<script src="/RGraph.line.js"></script>
<style>
  body {
    background-color: grey;
  }
  body.connected {
    background-color: white;
  }
</style>
</head>
<body>
<div id="status"></div>
<table class="mdl-data-table mdl-js-data-table" style="background-color: transparent !important;">
  <thead>
    <tr>
      <th class="mdl-data-table__cell--non-numeric">Position</th>
      <th>Target</th>
      <th>Value</th>
      <th class="mdl-data-table__cell--non-numeric">Velocity</th>
      <th>Target</th>
      <th>Value</th>
    </tr>
  </thead>
  <tbody>
    <tr id="repeatntimes">
      <td style="width:300px">
        <input class="mdl-slider mdl-js-slider posslider" type="range" id="s6" min="-3.14159" max="3.14159" value="0" step="0.1">
      </td>
      <td class="postgt">0</td>
      <td class="posval">#</td>
      <td style="width:300px">
        <input class="mdl-slider mdl-js-slider velslider" type="range" id="s6" min="0.01" max="0.1" value="0.01" step="0.01">
      </td>
      <td class="veltgt">0</td>
      <td class="velval">#</td>
    </tr>
  </tbody>
  <canvas id="cvs" width="800" height="150" style="width: 100%">[No canvas support]</canvas>
</table>
<script>
var ws = null; //See reconnect()
const NUM_J = 6;
let pos = [0,0,0,0,0,0];
let vel = [0,0,0,0,0,0];
let mask = [0,0,0,0,0,0];
let tpos = [0,0,0,0,0,0];
let tvel = [0,0,0,0,0,0];
let tmask = [0,0,0,0,0,0];
const STEPS_PER_REV = [4096,4096,4096,4096,4096,4096];
const GRAPH_DOMAIN_SEC = 20;
const SEND_STATE_PD_MILLIS = 100;

// https://www.rgraph.net/canvas/howto-scrolling.html
var graph = new RGraph.Line({
    id: 'cvs',
    data: [...Array(NUM_J)].map(e => Array(GRAPH_DOMAIN_SEC * 1000 / SEND_STATE_PD_MILLIS)),
    options: {
        yaxisScaleMax: 4,
        tickmarksStyle: null,
        linewidth: 1,
        shadow: null,
        backgroundGridVlines: false,
        backgroundGridBorder: false,
        backgroundGridColor: '#eee',
        xaxisLabels: ['20s','15s','10s','5s','0s'],
        xaxis: false,
        textSize: 7,
    }
}).draw();

// Expand the row to njoints
let tmpl = document.getElementById("repeatntimes");
let tbody = document.querySelector("tbody");
for (let i = 1; i < NUM_J; i++) {
  tbody.appendChild(tmpl.cloneNode(true));
}

let ui = {
  posslider: document.getElementsByClassName("posslider"),
  postgt: document.getElementsByClassName("postgt"),
  posval: document.getElementsByClassName("posval"),
  
  velslider: document.getElementsByClassName("velslider"),
  veltgt: document.getElementsByClassName("veltgt"),
  velval: document.getElementsByClassName("velval"),
};


for (let i = 0; i < NUM_J; i++) {
  ui.posslider[i].oninput = (e) => {
    tpos[i] = Math.round(e.target.value / (2*3.14159) * STEPS_PER_REV[i]);
    ui.postgt[i].innerText = parseFloat(e.target.value).toFixed(2);
  }
  ui.velslider[i].oninput = (e) => {
    tvel[i] = Math.round(e.target.value / (2*3.14159) * STEPS_PER_REV[i]);
    ui.veltgt[i].innerText = parseFloat(e.target.value).toFixed(2);
  }
}

function setStatus(status) {
  document.getElementById("status").innerText = status;
}

function millis() {
  return (new Date().getTime());
}

let lastSendState = 0;
function sendState() {
  if (ws.readyState === ws.OPEN) {
    ws.send([tmask.join(","), tpos.join(","), tvel.join(",")].join("|"));
    lastSendState = millis();
  }
}

function tick() {
  setStatus(lastSendState.toString());
  if (millis() > lastSendState + SEND_STATE_PD_MILLIS) {
    sendState();
  }

  // Clear (NOT reset) the canvas
  RGraph.clear(graph.canvas);
  graph.draw();
}
setInterval(tick, 100);

let last_event_log = millis();
const EVENT_LOG_PD = 2000;
function handleMessage(event) {
  let now = millis();
  if (now - last_event_log > EVENT_LOG_PD) {
    console.log(event.data);
    last_event_log = now;
  }
  mpv = event.data.split("|");
  m = mpv[0].split(",");
  p = mpv[1].split(",");
  v = mpv[2].split(",");
  for (let i = 0; i < NUM_J; i++) {
    mask[i]=m[i];
    pos[i]=p[i];
    vel[i]=v[i];
    let pos_norm = pos[i] * (2*3.14159)/STEPS_PER_REV[i];
    graph.original_data[i].shift();
    graph.original_data[i].push(pos_norm);
    ui.posval[i].innerText = (pos_norm).toFixed(2);
    ui.velval[i].innerText = (vel[i] * (2*3.14159)/STEPS_PER_REV[i]).toFixed(2);
  }
  
  tick();
}

function startWebsocket() {
  ws = new WebSocket(`ws://${document.location.hostname}:8001`);

  ws.onopen = (event) => {
    console.log("socket opened");
    setStatus(`Connected to ${ws.url}`);
    document.getElementsByTagName("body")[0].className = "connected";
    sendState();
  };

  ws.onclose = (event) => {
    console.log("socket closed, attempting reconnect in 5s");
    setStatus("Disconnected (reconnecting in 5s)");
    document.getElementsByTagName("body")[0].className = "";
    setTimeout(startWebsocket, 5000);
  };
  ws.onmessage = handleMessage;
}
startWebsocket();
</script>
</body>
</html>
